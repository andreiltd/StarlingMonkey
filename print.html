<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div align="center">
  <h1 id="starlingmonkey"><a class="header" href="#starlingmonkey"><code>StarlingMonkey</code></a></h1>
  <p>
    <strong>A SpiderMonkey-based JS runtime on WebAssembly</strong>
  </p>
<p><strong>A <a href="https://bytecodealliance.org/">Bytecode Alliance</a> project</strong></p>
  <p>
    <a href="https://github.com/bytecodealliance/StarlingMonkey/actions?query=workflow%3ACI"><img src="https://github.com/bytecodealliance/StarlingMonkey/workflows/CI/badge.svg" alt="build status" /></a>
    <a href="https://bytecodealliance.zulipchat.com/#narrow/stream/459697-StarlingMonkey"><img src="https://img.shields.io/badge/zulip-join_chat-brightgreen.svg" alt="zulip chat" /></a>
  </p>
  <h3>
    <a href="index.html#quick-start">Building</a>
    <span> | </span>
    <a href="ADOPTERS.html">Adopters</a>
    <span> | </span>
    <a href="index.html#documentation">Documentation</a>
    <span> | </span>
    <a href="https://bytecodealliance.zulipchat.com/#narrow/stream/459697-StarlingMonkey">Chat</a>
  </h3>
</div>
<p>StarlingMonkey is a [SpiderMonkey][spidermonkey] based JS runtime optimized for use in [WebAssembly
Components][wasm-component]. StarlingMonkey's core builtins target WASI 0.2.0 to support a Component
Model based event loop and standards-compliant implementations of key web builtins, including the
fetch API, WHATWG Streams, text encoding, and others. To support tailoring for specific use cases,
it's designed to be highly modular, and can be readily extended with custom builtins and host APIs.</p>
<p>StarlingMonkey is used in production for Fastly's JS Compute platform, and Fermyon's Spin JS SDK.
See the <a href="ADOPTERS.html">ADOPTERS</a> file for more details.</p>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>For comprehensive documentation, visit our [Documentation Site][gh-pages].</p>
<h2 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h2>
<h3 id="requirements"><a class="header" href="#requirements">Requirements</a></h3>
<p>The runtime's build is managed by <a href="https://cmake.org/">cmake</a>, which also takes care of downloading the build
dependencies. To properly manage the Rust toolchain, the build script expects
<a href="https://rustup.rs/">rustup</a> to be installed in the system.</p>
<h3 id="usage"><a class="header" href="#usage">Usage</a></h3>
<p>With sufficiently new versions of <code>cmake</code> and <code>rustup</code> installed, the build process is as follows:</p>
<ol>
<li>Clone the repo</li>
</ol>
<pre><code class="language-bash">git clone https://github.com/bytecodealliance/StarlingMonkey
cd StarlingMonkey
</code></pre>
<ol start="2">
<li>Run the configuration script</li>
</ol>
<p>For a release configuration, run</p>
<pre><code class="language-bash">cmake -S . -B cmake-build-release -DCMAKE_BUILD_TYPE=Release
</code></pre>
<p>For a debug configuration, run</p>
<pre><code class="language-bash">cmake -S . -B cmake-build-debug -DCMAKE_BUILD_TYPE=Debug
</code></pre>
<ol start="3">
<li>Build the runtime</li>
</ol>
<p>Building the runtime is done in two phases: first, cmake is used to build a raw version as a
WebAssembly core module. Then, that module is turned into a [WebAssembly Component][wasm-component]
using the <code>componentize.sh</code> script.</p>
<p>The following command will build the <code>starling-raw.wasm</code> runtime module in the <code>cmake-build-release</code>
directory:</p>
<pre><code class="language-bash"># Use cmake-build-debug for the debug build
# Change the value for `--parallel` to match the number of CPU cores in your system
cmake --build cmake-build-release --parallel 8
</code></pre>
<p>Then, the <code>starling-raw.wasm</code> module can be turned into a component with the following command:</p>
<pre><code class="language-bash">cd cmake-build-release
./componentize.sh -o starling.wasm
</code></pre>
<p>The resulting runtime can be used to load and evaluate JS code dynamically:</p>
<pre><code class="language-bash">wasmtime -S http starling.wasm -e "console.log('hello world')"
# or, to load a file:
wasmtime -S http --dir . starling.wasm index.js
</code></pre>
<p>Alternatively, a JS file can be provided during componentization:</p>
<pre><code class="language-bash">cd cmake-build-release
./componentize.sh index.js -o starling.wasm
</code></pre>
<p>This way, the JS file will be loaded during componentization, and the top-level code will be
executed, and can e.g. register a handler for the <code>fetch</code> event to serve HTTP requests.</p>
<p>[gh-pages]:<br />
[spidermonkey]: https://spidermonkey.dev/ [wasm-component]:
https://component-model.bytecodealliance.org/</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="building-and-running"><a class="header" href="#building-and-running">Building and Running</a></h1>
<h2 id="requirements-1"><a class="header" href="#requirements-1">Requirements</a></h2>
<p>The runtime's build is managed by <a href="https://cmake.org/">cmake</a>, which also takes care of downloading
the build dependencies. To properly manage the Rust toolchain, the build script expects
<a href="https://rustup.rs/">rustup</a> to be installed in the system.</p>
<p>See also <a href="getting-started/../developer/just.html">Project workflow using <code>just</code></a> for documentation on how to use
<code>just</code> to streamline the project interface.</p>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<p>With sufficiently new versions of <code>cmake</code> and <code>rustup</code> installed, the build process is as follows:</p>
<ol>
<li>Clone the repo</li>
</ol>
<pre><code class="language-bash">git clone https://github.com/bytecodealliance/StarlingMonkey
cd StarlingMonkey
</code></pre>
<ol start="2">
<li>Run the configuration script</li>
</ol>
<p>For a release configuration, run</p>
<pre><code class="language-bash">cmake -S . -B cmake-build-release -DCMAKE_BUILD_TYPE=Release
</code></pre>
<p>For a debug configuration, run</p>
<pre><code class="language-bash">cmake -S . -B cmake-build-debug -DCMAKE_BUILD_TYPE=Debug
</code></pre>
<ol start="3">
<li>Build the runtime</li>
</ol>
<p>Building the runtime is done in two phases: first, cmake is used to build a raw version as a
WebAssembly core module. Then, that module is turned into a
<a href="https://component-model.bytecodealliance.org/">WebAssembly Component</a> using the <code>componentize.sh</code>
script.</p>
<p>The following command will build the <code>starling-raw.wasm</code> runtime module in the <code>cmake-build-release</code>
directory:</p>
<pre><code class="language-bash"># Use cmake-build-debug for the debug build
# Change the value for `--parallel` to match the number of CPU cores in your system
cmake --build cmake-build-release --parallel 8
</code></pre>
<p>Then, the <code>starling-raw.wasm</code> module can be turned into a component with the following command:</p>
<pre><code class="language-bash">cd cmake-build-release
./componentize.sh -o starling.wasm
</code></pre>
<p>The resulting runtime can be used to load and evaluate JS code dynamically:</p>
<pre><code class="language-bash">wasmtime -S http starling.wasm -e "console.log('hello world')"
# or, to load a file:
wasmtime -S http --dir . starling.wasm index.js
</code></pre>
<p>Alternatively, a JS file can be provided during componentization:</p>
<pre><code class="language-bash">cd cmake-build-release
./componentize.sh index.js -o starling.wasm
</code></pre>
<p>This way, the JS file will be loaded during componentization, and the top-level code will be
executed, and can e.g. register a handler for the <code>fetch</code> event to serve HTTP requests.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing-starlingmonkey"><a class="header" href="#testing-starlingmonkey">Testing StarlingMonkey</a></h1>
<h2 id="testing-the-build"><a class="header" href="#testing-the-build">Testing the build</a></h2>
<p>After completing the build (a debug build in this case), the integration test runner can be built:</p>
<pre><code class="language-bash">cmake --build cmake-build-debug --target integration-test-server
</code></pre>
<p>Then tests can be run with <code>ctest</code> directly via:</p>
<pre><code class="language-bash">ctest --test-dir cmake-build-debug -j8 --output-on-failure
</code></pre>
<p>Alternatively, the integration test server can be directly run with <code>wasmtime serve</code> via:</p>
<pre><code class="language-bash">wasmtime serve -S common cmake-build-debug/test-server.wasm
</code></pre>
<p>Then visit http://0.0.0.0:8080/timers, or any test name and filter of the form <code>[testName]/[filter]</code></p>
<ol start="5">
<li>Using the runtime with other JS applications</li>
</ol>
<p>The build directory contains a shell script <code>componentize.sh</code> that can be used to create components
from JS applications. <code>componentize.sh</code> takes a single argument, the path to the JS application, and
creates a component with a name of the form <code>[input-file-name].wasm</code> in the current working
directory.</p>
<p>For example, the following command is equivalent to the <code>cmake</code> invocation from step 5, and will
create the component <code>cmake-build-release/smoke.wasm</code>:</p>
<pre><code class="language-bash">cd cmake-build-release
./componentize.sh ../tests/smoke.js
</code></pre>
<h2 id="web-platform-tests"><a class="header" href="#web-platform-tests">Web Platform Tests</a></h2>
<p>To run the <a href="https://web-platform-tests.org/">Web Platform Tests</a> suite, the WPT runner requires
<code>Node.js</code> to be installed, and during build configuration the option <code>ENABLE_WPT:BOOL=ON</code> must be
set.</p>
<pre><code class="language-bash">cmake -S . -B cmake-build-debug -DENABLE_WPT:BOOL=ON -DCMAKE_BUILD_TYPE=Debug
cmake --build cmake-build-debug --parallel 8 --target wpt-runtime
cd cmake-build-debug
ctest -R wpt --verbose # Note: some of the tests run fairly slowly in debug builds, so be patient
</code></pre>
<p>The Web Platform Tests checkout can also be customized by setting the
<code>WPT_ROOT=[path to your WPT checkout]</code> environment variable to the cmake command.</p>
<p>WPT tests can be filtered with the <code>WPT_FILTER=string</code> variable, for example:</p>
<pre><code class="language-bash">WPT_FILTER=fetch ctest -R wpt -v
</code></pre>
<p>Custom flags can also be passed to the test runner via <code>WPT_FLAGS="..."</code>, for example to update
expectations use:</p>
<pre><code class="language-bash">WPT_FLAGS="--update-expectations" ctest -R wpt -v
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-workflow-using-just"><a class="header" href="#project-workflow-using-just">Project workflow using <code>just</code></a></h1>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>The justfile provides a streamlined interface for executing common project-specific tasks. To
install just, you can use the command <code>cargo install just</code> or <code>cargo binstall just</code>. Alternatively,
refer to the official <a href="https://github.com/casey/just?tab=readme-ov-file#installation">installation instructions</a> for your specific system.</p>
<p>Once installed, navigate to the project directory and run <code>just</code> commands as needed. For instance,
the following commands will configure a default <code>cmake-build-debug</code> directory and build the project.</p>
<pre><code class="language-shell">just build
</code></pre>
<p>To load a JS script during componentization and serve its output using <code>Wasmtime</code>, run:</p>
<pre><code class="language-shell">just serve &lt;filename&gt;.js
</code></pre>
<p>To build and run integration tests run:</p>
<pre><code class="language-shell">just test
</code></pre>
<p>To build and run Web Platform Tests run:</p>
<pre><code class="language-shell">just wpt-test # run all tests
just wpt-test console/console-log-symbol.any.js # run specific test
</code></pre>
<p>To view a complete list of available recipes, run:</p>
<pre><code class="language-shell">just --list

</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>By default, the CMake configuration step is skipped if the build directory already exists.
However, this can sometimes cause issues if the existing build directory was configured for a
different target. For instance:</p>
<ul>
<li>Running <code>just build</code> creates a build directory for the default target,</li>
<li>Running <code>just wpt-build</code> afterward may fail because the WPT target hasn’t been configured in the
existing build directory.</li>
</ul>
<p>To resolve this, you can force cmake to reconfigure the build directory by adding the
<code>reconfigure=true</code> parameter. For example:</p>
<pre><code class="language-shell">just reconfigure=true wpt-build
</code></pre>
</blockquote>
<h2 id="customizing-build"><a class="header" href="#customizing-build">Customizing build</a></h2>
<p>The default build mode is debug, which automatically configures the build directory to
<code>cmake-build-debug</code>. You can switch to a different build mode, such as release, by specifying the
mode parameter. For example:</p>
<pre><code class="language-shell">just mode=release build
</code></pre>
<p>This command will set the build mode to release, and the build directory will automatically change
to <code>cmake-build-release</code>.</p>
<p>If you want to override the default build directory, you can use the <code>builddir</code> parameter.</p>
<pre><code class="language-shell">just builddir=mybuilddir mode=release build
</code></pre>
<p>This command configures CMake to use <code>mybuilddir</code> as the build directory and sets the build mode to
<code>release</code>.</p>
<h2 id="starting-the-wpt-server"><a class="header" href="#starting-the-wpt-server">Starting the WPT Server</a></h2>
<p>You can also start a Web Platform Tests (WPT) server with:</p>
<pre><code class="language-shell">just wpt-server
</code></pre>
<p>After starting the server, individual tests can be run by sending a request with the test name to
the server instance. For example:</p>
<pre><code class="language-shell">curl http://127.0.0.1:7676/console/console-log-symbol.any.js

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="devoloping-builtins-in-c"><a class="header" href="#devoloping-builtins-in-c">Devoloping builtins in C++</a></h1>
<h2 id="adding-custom-builtins"><a class="header" href="#adding-custom-builtins">Adding custom builtins</a></h2>
<p>Adding builtins is as simple as calling <code>add_builtin</code> in the importing project's <code>CMakeLists.txt</code>.
Say you want to add a builtin defined in the file <code>my-builtin.cpp</code>, like so:</p>
<pre><code class="language-cpp">// The extension API is automatically on the include path for builtins.
#include "extension-api.h"

// The namespace name must match the name passed to `add_builtin` in the CMakeLists.txt
namespace my_project::my_builtin {
  bool install(api::Engine* engine) {
    printf("installing my-builtin\n");
    return true;
  }
} // namespace my_builtin
</code></pre>
<p>This file can now be included in the runtime's builtins like so:</p>
<pre><code class="language-cmake">add_builtin(my_project::my_builtin SRC my-builtin.cpp)
</code></pre>
<p>If your builtin requires multiple <code>.cpp</code> files, you can pass all of them to <code>add_builtin</code> as values
for the <code>SRC</code> argument.</p>
<h2 id="writing-builtins"><a class="header" href="#writing-builtins">Writing builtins</a></h2>
<h3 id="rooting"><a class="header" href="#rooting">Rooting</a></h3>
<blockquote>
<p>SpiderMonkey has a moving GC, it is very important that it knows about each and every pointer to a
GC thing in the system. SpiderMonkey's rooting API tries to make this task as simple as possible.</p>
</blockquote>
<p>It is highly recommended that readers review the <code>SpiderMonkey</code>
<a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/next/docs/GC%20Rooting%20Guide.md">documentation</a> on rooting before proceeding with this section. For
convenience, here is a brief recap of the main rooting rules from the referenced page:</p>
<ul>
<li>Use <code>JS::Rooted&lt;T&gt;</code> typedefs for local variables on the stack.</li>
<li>Use <code>JS::Handle&lt;T&gt;</code> typedefs for function parameters.</li>
<li>Use <code>JS::MutableHandle&lt;T&gt;</code> typedefs for function out-parameters.</li>
<li>Use an implicit cast from <code>JS::Rooted&lt;T&gt;</code> to get a JS::Handle<T>.</li>
<li>Use an explicit address-of-operator on <code>JS::Rooted&lt;T&gt;</code> to get a JS::MutableHandle<T>.</li>
<li>Return raw pointers from functions.</li>
<li>Use <code>JS::Rooted&lt;T&gt;</code> fields when possible for aggregates, otherwise use an AutoRooter.</li>
<li>Use <code>JS::Heap&lt;T&gt;</code> members for heap data. Note: Heap<T> are not "rooted": they must be traced!</li>
<li>Do not use <code>JS::Rooted&lt;T&gt;,</code> JS::Handle<T> or JS::MutableHandle<T> on the heap.</li>
<li>Do not use <code>JS::Rooted&lt;T&gt;</code> for function parameters.</li>
<li>Use <code>JS::PersistentRooted&lt;T&gt;</code> for things that are alive until the process exits (or until you
manually delete the <code>PersistentRooted</code> for a reason not based on GC finalization.)</li>
</ul>
<h3 id="starlingmonkey-builtins-api"><a class="header" href="#starlingmonkey-builtins-api">StarlingMonkey builtins API</a></h3>
<p>The <code>builtin</code> API provided by StarlingMonkey is built on top of SpiderMonkey's
<a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/next/docs/JSAPI%20Introduction.md"><code>jsapi</code></a>, Mozilla's C++ interface for embedding JavaScript. It simplifies the
creation and management of native JavaScript classes and objects by abstracting common patterns and
boilerplate code required by the underlying SpiderMonkey engine. This allows developers to
efficiently implement native functionality while leveraging SpiderMonkey's robust JavaScript runtime
environment.</p>
<p>See also SpiderMonkey documentation on <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/next/docs/Custom%20Objects.md">Custom Objects</a>.</p>
<p>This section explains how to implement a native JavaScript class using the StarlingMonkey framework.
We'll use the following JavaScript class as an example:</p>
<pre><code class="language-js">class MyClass {
  constructor(a, b) {
    this._a = a;
    this._b = b;
  }

  get prop() {
    return 42;
  }
  method() {
    return this.a + this.b;
  }
  static get static_prop() {
    return "static";
  }
  static static_method(a, b) {
    return a + b;
  }
}
</code></pre>
<ul>
<li>Step 1: Define the Header File (<code>ma_class.h</code>)</li>
</ul>
<p>Create a header file to declare the native class and its methods/properties.</p>
<pre><code class="language-cpp">
#ifndef BUILTINS_MY_CLASS_H
#define BUILTINS_MY_CLASS_H

#include "builtin.h"

namespace builtins {
namespace my_class {

class MyClass : public BuiltinImpl&lt;MyClass&gt; {
  // Instance methods
  static bool method(JSContext *cx, unsigned argc, JS::Value *vp);
  static bool prop_get(JSContext *cx, unsigned argc, JS::Value *vp);

  // Static methods
  static bool static_method(JSContext *cx, unsigned argc, JS::Value *vp);
  static bool static_prop_get(JSContext *cx, unsigned argc, JS::Value *vp);

public:
  enum Slots { SlotA, SlotB, Count };

  static constexpr const char *class_name = "MyClass";
  static constexpr unsigned ctor_length = 2;

  static const JSFunctionSpec static_methods[];
  static const JSPropertySpec static_properties[];
  static const JSFunctionSpec methods[];
  static const JSPropertySpec properties[];

  static bool init_class(JSContext *cx, HandleObject global);
  static bool constructor(JSContext *cx, unsigned argc, Value *vp);
};

bool install(api::Engine *engine);

} // namespace my_class
} // namespace builtins

#endif // BUILTINS_MY_CLASS_H

- Step 2: Implement the Class (`my_class.cpp`)

```cpp
#include "my_class.h"

namespace builtins {
namespace my_class {

const JSFunctionSpec MyClass::methods[] = {
    JS_FN("method", MyClass::method, 0, JSPROP_ENUMERATE),
    JS_FS_END,
};

const JSPropertySpec MyClass::properties[] = {
    JS_PSG("prop", MyClass::prop_get, JSPROP_ENUMERATE),
    JS_STRING_SYM_PS(toStringTag, "MyClass", JSPROP_READONLY),
    JS_PS_END,
};

const JSFunctionSpec MyClass::static_methods[] = {
    JS_FN("static_method", MyClass::static_method, 2, JSPROP_ENUMERATE),
    JS_FS_END,
};

const JSPropertySpec MyClass::static_properties[] = {
    JS_PSG("static_prop", MyClass::static_prop_get, JSPROP_ENUMERATE),
    JS_PS_END,
};

// Constructor implementation
bool MyClass::constructor(JSContext *cx, unsigned argc, JS::Value *vp) {
  CTOR_HEADER("MyClass", 2);

  RootedObject self(cx, JS_NewObjectForConstructor(cx, &amp;class_, args));
  if (!self) {
    return false;
  }

  SetReservedSlot(self, Slots::SlotA, args.get(0));
  SetReservedSlot(self, Slots::SlotB, args.get(1));

  args.rval().setObject(*self);
  return true;
}

// Instance method implementation
bool MyClass::method(JSContext *cx, unsigned argc, JS::Value *vp) {
  METHOD_HEADER(0);

  double a, b;
  if (!JS::ToNumber(cx, JS::GetReservedSlot(self, Slots::SlotA), &amp;a) ||
      !JS::ToNumber(cx, JS::GetReservedSlot(self, Slots::SlotB), &amp;b)) {
    return false;
  }

  args.rval().setNumber(a + b);
  return true;
}

// Instance property getter implementation
bool MyClass::prop_get(JSContext *cx, unsigned argc, JS::Value *vp) {
  METHOD_HEADER(0);
  args.rval().setInt32(42);
  return true;
}

// Static method implementation
bool MyClass::static_method(JSContext *cx, unsigned argc, JS::Value *vp) {
  CallArgs args = CallArgsFromVp(argc, vp);
  if (!args.requireAtLeast(cx, "static_method", 2)) {
    return false;
  }

  double a, b;
  if (!JS::ToNumber(cx, args.get(0), &amp;a) ||
      !JS::ToNumber(cx, args.get(1), &amp;b)) {
    return false;
  }

  args.rval().setNumber(a + b);
  return true;
}

// Static property getter implementation
bool MyClass::static_prop_get(JSContext *cx, unsigned argc, JS::Value *vp) {
  CallArgs args = CallArgsFromVp(argc, vp);
  args.rval().setString(JS_NewStringCopyZ(cx, "static"));
  return true;
}

// Class initialization
bool MyClass::init_class(JSContext *cx, JS::HandleObject global) {
  return init_class_impl(cx, global);
}

bool install(api::Engine *engine) {
  return MyClass::init_class(engine-&gt;cx(), engine-&gt;global());
}

} // namespace my_class
} // namespace builtins
</code></pre>
<p>Deriving from <code>BuiltinImpl</code> automatically creates a <code>JSClass</code> definition using parameters provided
by the implementation:</p>
<h4 id="explanation-of-starlingmonkey-api-usage"><a class="header" href="#explanation-of-starlingmonkey-api-usage">Explanation of StarlingMonkey API Usage</a></h4>
<pre><code class="language-cpp">static constexpr JSClass class_{
    Impl::class_name,
    JSCLASS_HAS_RESERVED_SLOTS(static_cast&lt;uint32_t&gt;(Impl::Slots::Count)) | class_flags,
    &amp;class_ops,
};

</code></pre>
<ul>
<li>
<p><code>SetReservedSlot</code> and <code>GetReservedSlot</code>:</p>
<ul>
<li>Used to store and retrieve internal state associated with the JavaScript object.</li>
</ul>
</li>
<li>
<p><code>JSFunctionSpec</code> and <code>JSPropertySpec</code> arrays:</p>
<ul>
<li>Define instance/static methods and properties exposed to JavaScript.</li>
</ul>
</li>
</ul>
<p>StarlingMonkey provides macros and helper functions to simplify native class implementation:</p>
<ul>
<li>
<p><code>CTOR_HEADER(name, required_argc)</code>:</p>
<ul>
<li>Initializes constructor arguments.</li>
<li>Ensures the constructor is called with the <code>new</code> keyword.</li>
<li>Checks the minimum number of arguments.</li>
</ul>
</li>
<li>
<p><code>METHOD_HEADER(required_argc)</code>:</p>
<ul>
<li>Initializes method arguments.</li>
<li>Ensures the receiver (<del>this</del>) is an instance of the correct class.</li>
<li>Checks the minimum number of arguments.</li>
</ul>
</li>
<li>
<p><code>is_instance(JSObject *obj)</code>:</p>
<ul>
<li>used to verify if object passed is instance of builtin class.</li>
<li>used often as assertion in class methods, for example:
<pre><code class="language-cpp">JSString *MyObject::my_method(JSObject *self) {
  MOZ_ASSERT(is_instance(self));
  return JS::GetReservedSlot(self, Slots::MySlot).toString();
}
</code></pre>
</li>
</ul>
<pre><code>
</code></pre>
</li>
<li>
<p>Step 3: Register the Class with StarlingMonkey Engine</p>
</li>
</ul>
<p>Finally, ensure your class is installed into the StarlingMonkey engine during initialization:</p>
<pre><code class="language-cpp">// Example initialization code
#include "my_class.h"

void initialize_builtins(api::Engine *engine) {
  builtins::my_class::install(engine);
}

</code></pre>
<h2 id="providing-a-custom-host-api-implementation"><a class="header" href="#providing-a-custom-host-api-implementation">Providing a custom host API implementation</a></h2>
<p>The <a href="developer/../../../../host-apis">host-apis</a> directory can contain implementations of the host API for
different versions of WASI—or in theory any other host interface. Those can be selected by setting
the <code>HOST_API</code> environment variable to the name of one of the directories. Currently, only an
implementation in terms of <a href="developer/../../../../host-apis/wasi-0.2.0">wasi-0.2.0</a> is provided, and used by default.</p>
<p>To provide a custom host API implementation, you can set <code>HOST_API</code> to the (absolute) path of a
directory containing that implementation.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="devoloping-builtins-in-rust"><a class="header" href="#devoloping-builtins-in-rust">Devoloping Builtins in Rust</a></h1>
<p>[TODO]</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developing-changes-to-spidermonkey"><a class="header" href="#developing-changes-to-spidermonkey">Developing Changes to SpiderMonkey</a></h1>
<p>StarlingMonkey uses SpiderMonkey as its underlying JS engine, and by default, downloads build
artifacts from <a href="developer/wasi-embedding">a wrapper repository</a> around
<a href="developer/geck-dev">our local SpiderMonkey tree</a>. That wrapper repository contains a SpiderMonkey commit-hash
in a file, and its CI jobs build the artifacts that StarlingMonkey downloads during its build.</p>
<p>This flow is optimized for ease of development of StarlingMonkey, and avoiding the need to build
SpiderMonkey locally, which requires some additional tools and is resource-intensive. However,
sometimes it is necessary or desirable to make modifications to SpiderMonkey directly, whether to
make fixes or optimize performance.</p>
<p>In order to do so, first clone the above two repositories, with <code>gecko-dev</code> (SpiderMonkey itself) as
a subdirectory to <code>spidermonkey-wasi-embedding</code>:</p>
<pre><code class="language-shell">git clone https://github.com/bytecodealliance/spidermonkey-wasi-embedding
cd spidermonkey-wasi-embedding/
git clone https://github.com/bytecodealliance/gecko-dev
</code></pre>
<p>and switch to the commit that we are currently using:</p>
<pre><code class="language-shell">git checkout `cat ../gecko-revision`
# now edit the source
</code></pre>
<p>Then make changes as necessary, eventually rebuilding from the <code>spidermonkey-wasi-embedding</code> root:</p>
<pre><code class="language-shell">cd ../ # back to spidermonkey-wasi-embedding
./rebuild.sh release
</code></pre>
<p>This will produce a <code>release/</code> directory with artifacts of the same form normally downloaded by
StarlingMonkey. So, finally, from within StarlingMonkey, set an environment variable
<code>SPIDERMONKEY_BINARIES</code>:</p>
<pre><code class="language-shell">export SPIDERMONKEY_BINARIES=/path/to/spidermonkey-wasi-embedding/release
cmake -S . -B cmake-build-release -DCMAKE_BUILD_TYPE=Release
cmake --build cmake-build-release --parallel 8
</code></pre>
<p>and use/test as above.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="debugging-starlingmonkey-application"><a class="header" href="#debugging-starlingmonkey-application">Debugging StarlingMonkey application</a></h1>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="community"><a class="header" href="#community">Community</a></h1>
<h2 id="reaching-out"><a class="header" href="#reaching-out">Reaching out</a></h2>
<p>Ask questions in the BytecodeAlliance Zullip <a href="resources/starlingmonkey">#StarlingMonkey</a> channel</p>
<h2 id="code-of-conduct"><a class="header" href="#code-of-conduct">Code of Conduct</a></h2>
<p>StarlingMonkey follows the <a href="resources/../CODE_OF_CONDUCT.html">BytecodeAlliance Code of Conduct</a>. We are
committed to providing a welcoming and inclusive environment for all participants.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="starlingmonkey-adopters"><a class="header" href="#starlingmonkey-adopters">StarlingMonkey Adopters</a></h1>
<p><em>If you are using StarlingMonkey in production at your organization, please add your company name to
this list. The list is in alphabetical order.</em></p>
<div class="table-wrapper"><table><thead><tr><th>Organization</th><th>Contact</th><th>Status</th><th>Description of Use</th></tr></thead><tbody>
<tr><td><a href="https://www.fastly.com">Fastly</a></td><td><a href="https://github.com/guybedford">@guybedford</a></td><td><img src="https://img.shields.io/badge/-production-blue?style=flat" alt="production" /></td><td>Fastly's <a href="https://github.com/fastly/js-compute-runtime">JS SDK</a> for Compute at edge is powered by StarlingMonkey.</td></tr>
<tr><td><a href="https://www.fermyon.com/">Fermyon</a></td><td><a href="https://github.com/tschneidereit">@tschneidereit</a></td><td><img src="https://img.shields.io/badge/-production-blue?style=flat" alt="production" /></td><td><a href="https://www.fermyon.com/spin">Fermyon Spin</a> supports serverless Wasm apps, using StarlingMonkey for its <a href="https://github.com/fermyon/spin-js-sdk">Spin JS SDK</a>.</td></tr>
<tr><td><a href="https://riza.io/">Riza</a></td><td><a href="https://github.com/kyleconroy">@kyleconroy</a></td><td><img src="https://img.shields.io/badge/-production-blue?style=flat" alt="production" /></td><td>The <a href="https://docs.riza.io">Riza Code Interpreter API</a> relies on StarlingMonkey for isolated JavaScript execution.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="contributor-covenant-code-of-conduct"><a class="header" href="#contributor-covenant-code-of-conduct">Contributor Covenant Code of Conduct</a></h1>
<p><em>Note</em>: this Code of Conduct pertains to individuals' behavior. Please also see the <a href="https://github.com/bytecodealliance/wasmtime/blob/main/ORG_CODE_OF_CONDUCT.md">Organizational Code of Conduct</a>.</p>
<h2 id="our-pledge"><a class="header" href="#our-pledge">Our Pledge</a></h2>
<p>In the interest of fostering an open and welcoming environment, we as contributors and maintainers pledge to making participation in our project and our community a harassment-free experience for everyone, regardless of age, body size, disability, ethnicity, gender identity and expression, level of experience, nationality, personal appearance, race, religion, or sexual identity and orientation.</p>
<h2 id="our-standards"><a class="header" href="#our-standards">Our Standards</a></h2>
<p>Examples of behavior that contributes to creating a positive environment include:</p>
<ul>
<li>Using welcoming and inclusive language</li>
<li>Being respectful of differing viewpoints and experiences</li>
<li>Gracefully accepting constructive criticism</li>
<li>Focusing on what is best for the community</li>
<li>Showing empathy towards other community members</li>
</ul>
<p>Examples of unacceptable behavior by participants include:</p>
<ul>
<li>The use of sexualized language or imagery and unwelcome sexual attention or advances</li>
<li>Trolling, insulting/derogatory comments, and personal or political attacks</li>
<li>Public or private harassment</li>
<li>Publishing others' private information, such as a physical or electronic address, without explicit permission</li>
<li>Other conduct which could reasonably be considered inappropriate in a professional setting</li>
</ul>
<h2 id="our-responsibilities"><a class="header" href="#our-responsibilities">Our Responsibilities</a></h2>
<p>Project maintainers are responsible for clarifying the standards of acceptable behavior and are expected to take appropriate and fair corrective action in response to any instances of unacceptable behavior.</p>
<p>Project maintainers have the right and responsibility to remove, edit, or reject comments, commits, code, wiki edits, issues, and other contributions that are not aligned to this Code of Conduct, or to ban temporarily or permanently any contributor for other behaviors that they deem inappropriate, threatening, offensive, or harmful.</p>
<h2 id="scope"><a class="header" href="#scope">Scope</a></h2>
<p>This Code of Conduct applies both within project spaces and in public spaces when an individual is representing the project or its community. Examples of representing a project or community include using an official project e-mail address, posting via an official social media account, or acting as an appointed representative at an online or offline event. Representation of a project may be further defined and clarified by project maintainers.</p>
<h2 id="enforcement"><a class="header" href="#enforcement">Enforcement</a></h2>
<p>Instances of abusive, harassing, or otherwise unacceptable behavior may be reported by contacting the Bytecode Alliance CoC team at <a href="mailto:report@bytecodealliance.org">report@bytecodealliance.org</a>. The CoC team will review and investigate all complaints, and will respond in a way that it deems appropriate to the circumstances. The CoC team is obligated to maintain confidentiality with regard to the reporter of an incident. Further details of specific enforcement policies may be posted separately.</p>
<p>Project maintainers who do not follow or enforce the Code of Conduct in good faith may face temporary or permanent repercussions as determined by other members of the Bytecode Alliance's leadership.</p>
<h2 id="attribution"><a class="header" href="#attribution">Attribution</a></h2>
<p>This Code of Conduct is adapted from the <a href="https://www.contributor-covenant.org">Contributor Covenant</a>, version 1.4, available at <a href="https://www.contributor-covenant.org/version/1/4/">http://contributor-covenant.org/version/1/4</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
