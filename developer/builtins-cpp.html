<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Devoloping Builtins in C++</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="devoloping-builtins-in-c"><a class="header" href="#devoloping-builtins-in-c">Devoloping builtins in C++</a></h1>
<h2 id="adding-custom-builtins"><a class="header" href="#adding-custom-builtins">Adding custom builtins</a></h2>
<p>Adding builtins is as simple as calling <code>add_builtin</code> in the importing project's <code>CMakeLists.txt</code>.
Say you want to add a builtin defined in the file <code>my-builtin.cpp</code>, like so:</p>
<pre><code class="language-cpp">// The extension API is automatically on the include path for builtins.
#include "extension-api.h"

// The namespace name must match the name passed to `add_builtin` in the CMakeLists.txt
namespace my_project::my_builtin {
  bool install(api::Engine* engine) {
    printf("installing my-builtin\n");
    return true;
  }
} // namespace my_builtin
</code></pre>
<p>This file can now be included in the runtime's builtins like so:</p>
<pre><code class="language-cmake">add_builtin(my_project::my_builtin SRC my-builtin.cpp)
</code></pre>
<p>If your builtin requires multiple <code>.cpp</code> files, you can pass all of them to <code>add_builtin</code> as values
for the <code>SRC</code> argument.</p>
<h2 id="writing-builtins"><a class="header" href="#writing-builtins">Writing builtins</a></h2>
<h3 id="rooting"><a class="header" href="#rooting">Rooting</a></h3>
<blockquote>
<p>SpiderMonkey has a moving GC, it is very important that it knows about each and every pointer to a
GC thing in the system. SpiderMonkey's rooting API tries to make this task as simple as possible.</p>
</blockquote>
<p>It is highly recommended that readers review the <code>SpiderMonkey</code>
<a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/next/docs/GC%20Rooting%20Guide.md">documentation</a> on rooting before proceeding with this section. For
convenience, here is a brief recap of the main rooting rules from the referenced page:</p>
<ul>
<li>Use <code>JS::Rooted&lt;T&gt;</code> typedefs for local variables on the stack.</li>
<li>Use <code>JS::Handle&lt;T&gt;</code> typedefs for function parameters.</li>
<li>Use <code>JS::MutableHandle&lt;T&gt;</code> typedefs for function out-parameters.</li>
<li>Use an implicit cast from <code>JS::Rooted&lt;T&gt;</code> to get a JS::Handle<T>.</li>
<li>Use an explicit address-of-operator on <code>JS::Rooted&lt;T&gt;</code> to get a JS::MutableHandle<T>.</li>
<li>Return raw pointers from functions.</li>
<li>Use <code>JS::Rooted&lt;T&gt;</code> fields when possible for aggregates, otherwise use an AutoRooter.</li>
<li>Use <code>JS::Heap&lt;T&gt;</code> members for heap data. Note: Heap<T> are not "rooted": they must be traced!</li>
<li>Do not use <code>JS::Rooted&lt;T&gt;,</code> JS::Handle<T> or JS::MutableHandle<T> on the heap.</li>
<li>Do not use <code>JS::Rooted&lt;T&gt;</code> for function parameters.</li>
<li>Use <code>JS::PersistentRooted&lt;T&gt;</code> for things that are alive until the process exits (or until you
manually delete the <code>PersistentRooted</code> for a reason not based on GC finalization.)</li>
</ul>
<h3 id="starlingmonkey-builtins-api"><a class="header" href="#starlingmonkey-builtins-api">StarlingMonkey builtins API</a></h3>
<p>The <code>builtin</code> API provided by StarlingMonkey is built on top of SpiderMonkey's
<a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/next/docs/JSAPI%20Introduction.md"><code>jsapi</code></a>, Mozilla's C++ interface for embedding JavaScript. It simplifies the
creation and management of native JavaScript classes and objects by abstracting common patterns and
boilerplate code required by the underlying SpiderMonkey engine. This allows developers to
efficiently implement native functionality while leveraging SpiderMonkey's robust JavaScript runtime
environment.</p>
<p>See also SpiderMonkey documentation on <a href="https://github.com/mozilla-spidermonkey/spidermonkey-embedding-examples/blob/next/docs/Custom%20Objects.md">Custom Objects</a>.</p>
<p>This section explains how to implement a native JavaScript class using the StarlingMonkey framework.
We'll use the following JavaScript class as an example:</p>
<pre><code class="language-js">class MyClass {
  constructor(a, b) {
    this._a = a;
    this._b = b;
  }

  get prop() {
    return 42;
  }
  method() {
    return this.a + this.b;
  }
  static get static_prop() {
    return "static";
  }
  static static_method(a, b) {
    return a + b;
  }
}
</code></pre>
<ul>
<li>Step 1: Define the Header File (<code>ma_class.h</code>)</li>
</ul>
<p>Create a header file to declare the native class and its methods/properties.</p>
<pre><code class="language-cpp">
#ifndef BUILTINS_MY_CLASS_H
#define BUILTINS_MY_CLASS_H

#include "builtin.h"

namespace builtins {
namespace my_class {

class MyClass : public BuiltinImpl&lt;MyClass&gt; {
  // Instance methods
  static bool method(JSContext *cx, unsigned argc, JS::Value *vp);
  static bool prop_get(JSContext *cx, unsigned argc, JS::Value *vp);

  // Static methods
  static bool static_method(JSContext *cx, unsigned argc, JS::Value *vp);
  static bool static_prop_get(JSContext *cx, unsigned argc, JS::Value *vp);

public:
  enum Slots { SlotA, SlotB, Count };

  static constexpr const char *class_name = "MyClass";
  static constexpr unsigned ctor_length = 2;

  static const JSFunctionSpec static_methods[];
  static const JSPropertySpec static_properties[];
  static const JSFunctionSpec methods[];
  static const JSPropertySpec properties[];

  static bool init_class(JSContext *cx, HandleObject global);
  static bool constructor(JSContext *cx, unsigned argc, Value *vp);
};

bool install(api::Engine *engine);

} // namespace my_class
} // namespace builtins

#endif // BUILTINS_MY_CLASS_H

- Step 2: Implement the Class (`my_class.cpp`)

```cpp
#include "my_class.h"

namespace builtins {
namespace my_class {

const JSFunctionSpec MyClass::methods[] = {
    JS_FN("method", MyClass::method, 0, JSPROP_ENUMERATE),
    JS_FS_END,
};

const JSPropertySpec MyClass::properties[] = {
    JS_PSG("prop", MyClass::prop_get, JSPROP_ENUMERATE),
    JS_STRING_SYM_PS(toStringTag, "MyClass", JSPROP_READONLY),
    JS_PS_END,
};

const JSFunctionSpec MyClass::static_methods[] = {
    JS_FN("static_method", MyClass::static_method, 2, JSPROP_ENUMERATE),
    JS_FS_END,
};

const JSPropertySpec MyClass::static_properties[] = {
    JS_PSG("static_prop", MyClass::static_prop_get, JSPROP_ENUMERATE),
    JS_PS_END,
};

// Constructor implementation
bool MyClass::constructor(JSContext *cx, unsigned argc, JS::Value *vp) {
  CTOR_HEADER("MyClass", 2);

  RootedObject self(cx, JS_NewObjectForConstructor(cx, &amp;class_, args));
  if (!self) {
    return false;
  }

  SetReservedSlot(self, Slots::SlotA, args.get(0));
  SetReservedSlot(self, Slots::SlotB, args.get(1));

  args.rval().setObject(*self);
  return true;
}

// Instance method implementation
bool MyClass::method(JSContext *cx, unsigned argc, JS::Value *vp) {
  METHOD_HEADER(0);

  double a, b;
  if (!JS::ToNumber(cx, JS::GetReservedSlot(self, Slots::SlotA), &amp;a) ||
      !JS::ToNumber(cx, JS::GetReservedSlot(self, Slots::SlotB), &amp;b)) {
    return false;
  }

  args.rval().setNumber(a + b);
  return true;
}

// Instance property getter implementation
bool MyClass::prop_get(JSContext *cx, unsigned argc, JS::Value *vp) {
  METHOD_HEADER(0);
  args.rval().setInt32(42);
  return true;
}

// Static method implementation
bool MyClass::static_method(JSContext *cx, unsigned argc, JS::Value *vp) {
  CallArgs args = CallArgsFromVp(argc, vp);
  if (!args.requireAtLeast(cx, "static_method", 2)) {
    return false;
  }

  double a, b;
  if (!JS::ToNumber(cx, args.get(0), &amp;a) ||
      !JS::ToNumber(cx, args.get(1), &amp;b)) {
    return false;
  }

  args.rval().setNumber(a + b);
  return true;
}

// Static property getter implementation
bool MyClass::static_prop_get(JSContext *cx, unsigned argc, JS::Value *vp) {
  CallArgs args = CallArgsFromVp(argc, vp);
  args.rval().setString(JS_NewStringCopyZ(cx, "static"));
  return true;
}

// Class initialization
bool MyClass::init_class(JSContext *cx, JS::HandleObject global) {
  return init_class_impl(cx, global);
}

bool install(api::Engine *engine) {
  return MyClass::init_class(engine-&gt;cx(), engine-&gt;global());
}

} // namespace my_class
} // namespace builtins
</code></pre>
<p>Deriving from <code>BuiltinImpl</code> automatically creates a <code>JSClass</code> definition using parameters provided
by the implementation:</p>
<h4 id="explanation-of-starlingmonkey-api-usage"><a class="header" href="#explanation-of-starlingmonkey-api-usage">Explanation of StarlingMonkey API Usage</a></h4>
<pre><code class="language-cpp">static constexpr JSClass class_{
    Impl::class_name,
    JSCLASS_HAS_RESERVED_SLOTS(static_cast&lt;uint32_t&gt;(Impl::Slots::Count)) | class_flags,
    &amp;class_ops,
};

</code></pre>
<ul>
<li>
<p><code>SetReservedSlot</code> and <code>GetReservedSlot</code>:</p>
<ul>
<li>Used to store and retrieve internal state associated with the JavaScript object.</li>
</ul>
</li>
<li>
<p><code>JSFunctionSpec</code> and <code>JSPropertySpec</code> arrays:</p>
<ul>
<li>Define instance/static methods and properties exposed to JavaScript.</li>
</ul>
</li>
</ul>
<p>StarlingMonkey provides macros and helper functions to simplify native class implementation:</p>
<ul>
<li>
<p><code>CTOR_HEADER(name, required_argc)</code>:</p>
<ul>
<li>Initializes constructor arguments.</li>
<li>Ensures the constructor is called with the <code>new</code> keyword.</li>
<li>Checks the minimum number of arguments.</li>
</ul>
</li>
<li>
<p><code>METHOD_HEADER(required_argc)</code>:</p>
<ul>
<li>Initializes method arguments.</li>
<li>Ensures the receiver (<del>this</del>) is an instance of the correct class.</li>
<li>Checks the minimum number of arguments.</li>
</ul>
</li>
<li>
<p><code>is_instance(JSObject *obj)</code>:</p>
<ul>
<li>used to verify if object passed is instance of builtin class.</li>
<li>used often as assertion in class methods, for example:
<pre><code class="language-cpp">JSString *MyObject::my_method(JSObject *self) {
  MOZ_ASSERT(is_instance(self));
  return JS::GetReservedSlot(self, Slots::MySlot).toString();
}
</code></pre>
</li>
</ul>
<pre><code>
</code></pre>
</li>
<li>
<p>Step 3: Register the Class with StarlingMonkey Engine</p>
</li>
</ul>
<p>Finally, ensure your class is installed into the StarlingMonkey engine during initialization:</p>
<pre><code class="language-cpp">// Example initialization code
#include "my_class.h"

void initialize_builtins(api::Engine *engine) {
  builtins::my_class::install(engine);
}

</code></pre>
<h2 id="providing-a-custom-host-api-implementation"><a class="header" href="#providing-a-custom-host-api-implementation">Providing a custom host API implementation</a></h2>
<p>The <a href="../../../../host-apis">host-apis</a> directory can contain implementations of the host API for
different versions of WASI—or in theory any other host interface. Those can be selected by setting
the <code>HOST_API</code> environment variable to the name of one of the directories. Currently, only an
implementation in terms of <a href="../../../../host-apis/wasi-0.2.0">wasi-0.2.0</a> is provided, and used by default.</p>
<p>To provide a custom host API implementation, you can set <code>HOST_API</code> to the (absolute) path of a
directory containing that implementation.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../developer/just.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../developer/builtins-rust.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../developer/just.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../developer/builtins-rust.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
